<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CeramicaDatabase - Unified Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .header {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header h1 {
            color: #4fc3f7;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .collection-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .collection-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        .collection-tab.active {
            background: var(--tab-color, #4fc3f7);
            color: #000;
            font-weight: bold;
        }
        .collection-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }
        .controls {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .controls label { color: #888; font-size: 0.75em; }
        .controls select, .controls input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
        }
        .stats {
            margin-left: auto;
            background: rgba(79, 195, 247, 0.15);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            color: #4fc3f7;
        }
        .main-container { display: flex; height: calc(100vh - 130px); }
        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.25);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .item-list { padding: 8px; }
        .item-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            display: flex;
            gap: 8px;
        }
        .item-card:hover { background: rgba(255, 255, 255, 0.1); }
        .item-card.active {
            background: rgba(79, 195, 247, 0.15);
            border-left-color: var(--collection-color, #4fc3f7);
        }
        .item-card img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .item-card .info { flex: 1; min-width: 0; overflow: hidden; }
        .item-card .id {
            font-weight: 600;
            color: #fff;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-card .period {
            font-size: 0.7em;
            color: #ff9800;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-card .meta {
            font-size: 0.65em;
            color: #888;
            margin-top: 2px;
        }
        .item-card .tags {
            display: flex;
            gap: 3px;
            margin-top: 3px;
            flex-wrap: wrap;
        }
        .tag {
            font-size: 0.55em;
            padding: 1px 5px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }
        .tag.decorated { background: #e91e63; color: white; }
        .tag.plain { background: #607d8b; color: white; }
        .tag.vessel { background: #2196f3; color: white; }
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .image-viewer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }
        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(79, 195, 247, 0.2);
            border: none;
            color: #4fc3f7;
            font-size: 1.8em;
            padding: 12px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 5px;
        }
        .nav-btn:hover { background: rgba(79, 195, 247, 0.4); }
        .nav-btn.prev { left: 10px; }
        .nav-btn.next { right: 10px; }
        .rotate-btns {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .rotate-btn {
            background: rgba(156, 39, 176, 0.6);
            border: none;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
        }
        .rotate-btn:hover { background: rgba(156, 39, 176, 0.9); }
        .metadata-panel {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 220px;
            overflow-y: auto;
        }
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        .meta-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 10px;
            border-radius: 5px;
            border-left: 3px solid #4fc3f7;
        }
        .meta-item .label {
            font-size: 0.65em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .meta-item .value {
            font-size: 0.85em;
            color: #fff;
            word-break: break-word;
        }
        .meta-item.editable .value {
            cursor: pointer;
            border-bottom: 1px dashed rgba(255,255,255,0.3);
        }
        .meta-item.editable .value:hover {
            background: rgba(255,255,255,0.1);
        }
        .meta-item.period { border-left-color: #ff9800; }
        .meta-item.period .value { color: #ff9800; font-weight: bold; }
        .meta-item.decoration { border-left-color: #e91e63; }
        .meta-item.decoration .value { color: #e91e63; }
        .meta-item.vessel_type { border-left-color: #2196f3; }
        .meta-item.vessel_type .value { color: #2196f3; }
        .meta-item.part_type { border-left-color: #9c27b0; }
        .meta-item.part_type .value { color: #9c27b0; }
        .meta-item.page-ref { border-left-color: #4caf50; }
        .meta-item.page-ref .value {
            color: #4caf50;
            cursor: pointer;
            text-decoration: underline;
        }
        .meta-item.collection { border-left-color: var(--collection-color, #4fc3f7); }
        .action-btn {
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s ease;
        }
        .action-btn:hover { transform: scale(1.05); }
        .pdf-btn { background: linear-gradient(135deg, #4caf50, #45a049); }
        .delete-btn { background: linear-gradient(135deg, #f44336, #d32f2f); }
        .select-btn { background: linear-gradient(135deg, #9c27b0, #7b1fa2); }
        .select-btn.active { background: linear-gradient(135deg, #ff9800, #f57c00); }
        .edit-btn { background: linear-gradient(135deg, #2196f3, #1976d2); }
        .batch-btn {
            background: linear-gradient(135deg, #ff5722, #e64a19);
            display: none;
        }
        .batch-btn.visible { display: inline-block; }
        .no-image { color: #666; text-align: center; padding: 20px; }
        .item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #9c27b0;
            flex-shrink: 0;
            display: none;
        }
        .select-mode .item-checkbox { display: block; }
        .item-card.selected {
            background: rgba(156, 39, 176, 0.25);
            border-left-color: #9c27b0;
        }
        .selection-count {
            background: rgba(156, 39, 176, 0.3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            color: #ce93d8;
            display: none;
        }
        .selection-count.visible { display: inline-block; }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            color: #4fc3f7;
        }
        .loading-spinner {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(79, 195, 247, 0.2);
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #2a2a4a;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .modal h3 { color: #4fc3f7; margin-bottom: 15px; }
        .modal p { margin-bottom: 15px; color: #ccc; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .modal-btn.cancel { background: #555; color: #fff; }
        .modal-btn.confirm { background: #4caf50; color: #fff; }
        .modal-btn.danger { background: #f44336; color: #fff; }
        .modal-btn:hover { opacity: 0.85; }
        .edit-form { display: flex; flex-direction: column; gap: 12px; }
        .edit-form label { color: #888; font-size: 0.8em; }
        .edit-form select, .edit-form input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .edit-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .edit-row label { width: 100px; flex-shrink: 0; }
        .edit-row select, .edit-row input { flex: 1; }
    </style>
</head>
<body>
    <div class="header">
        <h1>&#127994; CeramicaDatabase</h1>
        <div class="collection-tabs" id="collectionTabs"></div>
        <div class="header-buttons">
            <span class="selection-count" id="selectionCount">0 sel.</span>
            <button class="action-btn pdf-btn" onclick="openPdfAtPage()">&#128196; PDF</button>
            <button class="action-btn select-btn" id="selectBtn" onclick="toggleSelectMode()">&#9745; Select</button>
            <button class="action-btn batch-btn" id="batchEditBtn" onclick="openBatchEditModal()">&#9998; Edit Sel.</button>
            <button class="action-btn batch-btn" id="batchDeleteBtn" onclick="confirmBatchDelete()">&#128465; Delete Sel.</button>
            <button class="action-btn edit-btn" onclick="openEditModal()">&#9998; Edit</button>
            <button class="action-btn delete-btn" onclick="confirmDelete()">&#128465;</button>
        </div>
    </div>
    <div class="controls">
        <div class="control-group">
            <label>Macro-Period:</label>
            <select id="filterMacroPeriod">
                <option value="">All</option>
                <option value="Umm an-Nar">Umm an-Nar</option>
                <option value="Wadi Suq">Wadi Suq</option>
                <option value="Late Bronze Age">Late Bronze Age</option>
            </select>
        </div>
        <div class="control-group">
            <label>Decoration:</label>
            <select id="filterDecoration">
                <option value="">All</option>
                <option value="decorated">Decorated</option>
                <option value="plain">Plain</option>
            </select>
        </div>
        <div class="control-group">
            <label>Vessel Type:</label>
            <select id="filterVesselType">
                <option value="">All</option>
                <option value="jar">Jar</option>
                <option value="bowl">Bowl</option>
                <option value="cup">Cup</option>
                <option value="plate">Plate</option>
                <option value="pot">Pot</option>
            </select>
        </div>
        <div class="control-group">
            <label>Part:</label>
            <select id="filterPartType">
                <option value="">All</option>
                <option value="rim">Rim</option>
                <option value="base">Base</option>
                <option value="wall">Wall</option>
                <option value="complete">Complete</option>
            </select>
        </div>
        <div class="control-group">
            <label>Search:</label>
            <input type="text" id="searchInput" placeholder="ID, type...">
        </div>
        <div class="stats" id="stats">Loading...</div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div class="item-list" id="itemList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading data...</p>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="image-viewer" id="imageViewer">
                <div class="no-image"><p>Select an item from the list</p></div>
                <button class="nav-btn prev" onclick="navigate(-1)">&#8249;</button>
                <button class="nav-btn next" onclick="navigate(1)">&#8250;</button>
                <div class="rotate-btns">
                    <button class="rotate-btn" onclick="rotateImage(-90)" title="Rotate left">&#8634;</button>
                    <button class="rotate-btn" onclick="rotateImage(90)" title="Rotate right">&#8635;</button>
                    <button class="rotate-btn" onclick="rotateImage(180)" title="Flip">&#8693;</button>
                </div>
            </div>
            <div class="metadata-panel">
                <div class="metadata-grid" id="metadataGrid"></div>
            </div>
        </div>
    </div>

    <!-- Delete modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h3>&#9888; Confirm Delete</h3>
            <p id="deleteMessage">Are you sure you want to delete?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="modal-btn danger" onclick="executeDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3>&#9998; Edit Item</h3>
            <div class="edit-form">
                <div class="edit-row">
                    <label>Decoration:</label>
                    <select id="editDecoration">
                        <option value="plain">Plain</option>
                        <option value="decorated">Decorated</option>
                    </select>
                </div>
                <div class="edit-row">
                    <label>Vessel Type:</label>
                    <select id="editVesselType">
                        <option value="jar">Jar</option>
                        <option value="bowl">Bowl</option>
                        <option value="cup">Cup</option>
                        <option value="plate">Plate</option>
                        <option value="pot">Pot</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="edit-row">
                    <label>Part:</label>
                    <select id="editPartType">
                        <option value="rim">Rim</option>
                        <option value="base">Base</option>
                        <option value="wall">Wall</option>
                        <option value="complete">Complete</option>
                        <option value="fragment">Fragment</option>
                    </select>
                </div>
                <div class="edit-row">
                    <label>Period:</label>
                    <input type="text" id="editPeriod" placeholder="Chronological period">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('editModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Batch Edit modal -->
    <div class="modal-overlay" id="batchEditModal">
        <div class="modal">
            <h3>&#9998; Batch Edit (<span id="batchCount">0</span> items)</h3>
            <p style="font-size:0.8em;color:#888;">Leave empty to not change</p>
            <div class="edit-form">
                <div class="edit-row">
                    <label>Decoration:</label>
                    <select id="batchDecoration">
                        <option value="">-- Don't change --</option>
                        <option value="plain">Plain</option>
                        <option value="decorated">Decorated</option>
                    </select>
                </div>
                <div class="edit-row">
                    <label>Vessel Type:</label>
                    <select id="batchVesselType">
                        <option value="">-- Don't change --</option>
                        <option value="jar">Jar</option>
                        <option value="bowl">Bowl</option>
                        <option value="cup">Cup</option>
                        <option value="plate">Plate</option>
                        <option value="pot">Pot</option>
                    </select>
                </div>
                <div class="edit-row">
                    <label>Part:</label>
                    <select id="batchPartType">
                        <option value="">-- Don't change --</option>
                        <option value="rim">Rim</option>
                        <option value="base">Base</option>
                        <option value="wall">Wall</option>
                        <option value="complete">Complete</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('batchEditModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="saveBatchEdit()">Save All</button>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let filteredData = [];
        let currentIndex = 0;
        let config = {};
        let activeCollection = 'all';
        let selectMode = false;
        let selectedItems = new Set();

        // Load config and data
        Promise.all([
            fetch('/api/config').then(r => r.json()),
            fetch('/api/data').then(r => r.json())
        ]).then(([cfg, d]) => {
            config = cfg;
            data = d;
            initializeViewer();
        }).catch(err => {
            document.getElementById('itemList').innerHTML =
                '<div class="loading"><p>Errore: ' + err + '</p></div>';
        });

        function initializeViewer() {
            const tabs = document.getElementById('collectionTabs');
            tabs.innerHTML = '<button class="collection-tab active" data-collection="all">Tutti</button>';

            for (const [key, col] of Object.entries(config.collections || {})) {
                tabs.innerHTML += `<button class="collection-tab" data-collection="${key}" style="--tab-color: ${col.color}">${col.name}</button>`;
            }

            tabs.querySelectorAll('.collection-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.querySelectorAll('.collection-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    activeCollection = tab.dataset.collection;
                    applyFilters();
                });
            });

            // Filter listeners
            ['filterMacroPeriod', 'filterDecoration', 'filterVesselType', 'filterPartType'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            document.getElementById('searchInput').addEventListener('input', applyFilters);

            applyFilters();
        }

        function getCollectionColor(collection) {
            return config.collections?.[collection]?.color || '#4fc3f7';
        }

        function applyFilters() {
            const macroPeriod = document.getElementById('filterMacroPeriod').value;
            const decoration = document.getElementById('filterDecoration').value;
            const vesselType = document.getElementById('filterVesselType').value;
            const partType = document.getElementById('filterPartType').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredData = data.filter(item => {
                if (activeCollection !== 'all' && item.collection !== activeCollection) return false;
                if (macroPeriod && item.macro_period !== macroPeriod) return false;
                if (decoration && item.decoration !== decoration) return false;
                if (vesselType && item.vessel_type !== vesselType) return false;
                if (partType && item.part_type !== partType) return false;
                if (search && !JSON.stringify(item).toLowerCase().includes(search)) return false;
                return true;
            });

            document.getElementById('stats').textContent = `${filteredData.length} / ${data.length}`;
            renderList();
            if (filteredData.length > 0) selectItem(0);
            else {
                document.getElementById('imageViewer').innerHTML = '<div class="no-image"><p>No items found</p></div><div class="rotate-btns"></div>';
                document.getElementById('metadataGrid').innerHTML = '';
            }
        }

        function renderList() {
            const list = document.getElementById('itemList');
            if (filteredData.length === 0) {
                list.innerHTML = '<div class="no-image"><p>No items</p></div>';
                return;
            }

            list.innerHTML = filteredData.map((item, i) => `
                <div class="item-card ${i === currentIndex ? 'active' : ''} ${selectedItems.has(item.id) ? 'selected' : ''}"
                     onclick="handleCardClick(event, ${i})"
                     style="--collection-color: ${getCollectionColor(item.collection)}">
                    <input type="checkbox" class="item-checkbox"
                           ${selectedItems.has(item.id) ? 'checked' : ''}
                           onclick="toggleItemSelection(event, '${item.id}')">
                    <img src="${item.image_path || ''}" onerror="this.style.display='none'">
                    <div class="info">
                        <div class="id">${item.id || 'N/A'}</div>
                        <div class="period">${(item.macro_period || item.period || '').substring(0, 30)}</div>
                        <div class="tags">
                            <span class="tag ${item.decoration || ''}">${item.decoration || '?'}</span>
                            <span class="tag vessel">${item.vessel_type || '?'}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            if (selectMode) list.classList.add('select-mode');
            else list.classList.remove('select-mode');
        }

        function handleCardClick(event, index) {
            if (selectMode && event.target.type !== 'checkbox') {
                toggleItemSelection(event, filteredData[index].id);
            } else if (event.target.type !== 'checkbox') {
                selectItem(index);
            }
        }

        function toggleSelectMode() {
            selectMode = !selectMode;
            const btn = document.getElementById('selectBtn');
            const list = document.getElementById('itemList');

            if (selectMode) {
                btn.classList.add('active');
                btn.innerHTML = '&#10003; Exit Sel.';
                list.classList.add('select-mode');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '&#9745; Select';
                list.classList.remove('select-mode');
                selectedItems.clear();
            }
            updateSelectionUI();
            renderList();
        }

        function toggleItemSelection(event, itemId) {
            event.stopPropagation();
            if (selectedItems.has(itemId)) selectedItems.delete(itemId);
            else selectedItems.add(itemId);
            updateSelectionUI();
            renderList();
        }

        function updateSelectionUI() {
            const count = selectedItems.size;
            document.getElementById('selectionCount').textContent = `${count} sel.`;
            document.getElementById('selectionCount').classList.toggle('visible', count > 0);
            document.getElementById('batchDeleteBtn').classList.toggle('visible', count > 0);
            document.getElementById('batchEditBtn').classList.toggle('visible', count > 0);
        }

        function selectItem(index) {
            currentIndex = index;
            const item = filteredData[index];
            const color = getCollectionColor(item.collection);

            document.querySelectorAll('.item-card').forEach((el, i) => el.classList.toggle('active', i === index));
            document.querySelector('.item-card.active')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            const viewer = document.getElementById('imageViewer');
            viewer.innerHTML = `
                <img src="${item.image_path}?t=${Date.now()}" onerror="this.outerHTML='<div class=\'no-image\'><p>Immagine non trovata</p></div>'">
                <button class="nav-btn prev" onclick="navigate(-1)">&#8249;</button>
                <button class="nav-btn next" onclick="navigate(1)">&#8250;</button>
                <div class="rotate-btns">
                    <button class="rotate-btn" onclick="rotateImage(-90)" title="Rotate left">&#8634;</button>
                    <button class="rotate-btn" onclick="rotateImage(90)" title="Rotate right">&#8635;</button>
                    <button class="rotate-btn" onclick="rotateImage(180)" title="Flip">&#8693;</button>
                </div>
            `;

            const fields = [
                { key: 'id', label: 'ID' },
                { key: 'collection', label: 'Collezione', class: 'collection' },
                { key: 'decoration', label: 'Decorazione', class: 'decoration', editable: true },
                { key: 'vessel_type', label: 'Tipo Vaso', class: 'vessel_type', editable: true },
                { key: 'part_type', label: 'Parte', class: 'part_type', editable: true },
                { key: 'macro_period', label: 'Macro-Periodo', class: 'macro-period' },
                { key: 'period', label: 'Periodo', class: 'period', editable: true },
                { key: 'page_ref', label: 'Rif. PDF', class: 'page-ref', clickable: true },
                { key: 'figure_num', label: 'Figura' },
                { key: 'pottery_id', label: 'ID Ceramica' },
            ];

            document.getElementById('metadataGrid').innerHTML = fields
                .filter(f => item[f.key])
                .map(f => `
                    <div class="meta-item ${f.class || ''} ${f.editable ? 'editable' : ''}" style="--collection-color: ${color}">
                        <div class="label">${f.label}</div>
                        <div class="value" ${f.clickable ? `onclick="openPdfAtPage('${item[f.key]}', '${item.collection}')"` : ''}>
                            ${item[f.key] || '-'}
                        </div>
                    </div>
                `).join('');
        }

        function navigate(dir) {
            if (filteredData.length === 0) return;
            let idx = currentIndex + dir;
            if (idx < 0) idx = filteredData.length - 1;
            if (idx >= filteredData.length) idx = 0;
            selectItem(idx);
        }

        function rotateImage(degrees) {
            const item = filteredData[currentIndex];
            if (!item) return;

            fetch('/api/rotate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: item.image_path, degrees: degrees })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    // Reload image
                    selectItem(currentIndex);
                } else {
                    alert('Rotation error: ' + (result.error || 'Unknown'));
                }
            })
            .catch(err => alert('Error: ' + err));
        }

        function openPdfAtPage(pageRef, collection) {
            const item = filteredData[currentIndex];
            const page = pageRef || item?.page_ref || '1';
            const coll = collection || item?.collection || '';
            fetch(`/api/open-pdf?page=${encodeURIComponent(page)}&collection=${encodeURIComponent(coll)}`);
        }

        function openEditModal() {
            if (filteredData.length === 0) return;
            const item = filteredData[currentIndex];
            document.getElementById('editDecoration').value = item.decoration || 'plain';
            document.getElementById('editVesselType').value = item.vessel_type || 'unknown';
            document.getElementById('editPartType').value = item.part_type || 'rim';
            document.getElementById('editPeriod').value = item.period || '';
            document.getElementById('editModal').classList.add('active');
        }

        function saveEdit() {
            const item = filteredData[currentIndex];
            const fields = {
                decoration: document.getElementById('editDecoration').value,
                vessel_type: document.getElementById('editVesselType').value,
                part_type: document.getElementById('editPartType').value,
                period: document.getElementById('editPeriod').value
            };

            fetch('/api/update-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: item.id, fields: fields })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    // Update local data
                    Object.assign(item, fields);
                    item.macro_period = getMacroPeriod(item.period);
                    closeModal('editModal');
                    selectItem(currentIndex);
                    renderList();
                } else {
                    alert('Error: ' + (result.error || 'Unknown'));
                }
            })
            .catch(err => alert('Error: ' + err));
        }

        function getMacroPeriod(period) {
            if (!period) return '';
            const p = period.toLowerCase();
            if (p.includes('umm') || p.includes('hili') || p.includes('2700') || p.includes('2500')) return 'Umm an-Nar';
            if (p.includes('wadi') || p.includes('2000-1600')) return 'Wadi Suq';
            if (p.includes('bronze') || p.includes('fer') || p.includes('masafi') || p.includes('1600')) return 'Late Bronze Age';
            return '';
        }

        function openBatchEditModal() {
            if (selectedItems.size === 0) return;
            document.getElementById('batchCount').textContent = selectedItems.size;
            document.getElementById('batchDecoration').value = '';
            document.getElementById('batchVesselType').value = '';
            document.getElementById('batchPartType').value = '';
            document.getElementById('batchEditModal').classList.add('active');
        }

        function saveBatchEdit() {
            const fields = {};
            const dec = document.getElementById('batchDecoration').value;
            const vessel = document.getElementById('batchVesselType').value;
            const part = document.getElementById('batchPartType').value;

            if (dec) fields.decoration = dec;
            if (vessel) fields.vessel_type = vessel;
            if (part) fields.part_type = part;

            if (Object.keys(fields).length === 0) {
                alert('Select at least one field to change');
                return;
            }

            fetch('/api/update-batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: Array.from(selectedItems), fields: fields })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    // Update local data
                    for (const id of selectedItems) {
                        const item = data.find(d => d.id === id);
                        if (item) Object.assign(item, fields);
                    }
                    closeModal('batchEditModal');
                    applyFilters();
                    alert(`Updated ${result.updated} items`);
                } else {
                    alert('Error: ' + (result.error || 'Unknown'));
                }
            })
            .catch(err => alert('Error: ' + err));
        }

        function confirmDelete() {
            if (filteredData.length === 0) return;
            const item = filteredData[currentIndex];
            document.getElementById('deleteMessage').innerHTML = `Eliminare <strong>${item.id}</strong>?`;
            document.getElementById('deleteModal').dataset.batch = '';
            document.getElementById('deleteModal').classList.add('active');
        }

        function confirmBatchDelete() {
            if (selectedItems.size === 0) return;
            document.getElementById('deleteMessage').innerHTML = `Eliminare <strong>${selectedItems.size} elementi</strong>?`;
            document.getElementById('deleteModal').dataset.batch = 'true';
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function executeDelete() {
            const modal = document.getElementById('deleteModal');
            const isBatch = modal.dataset.batch === 'true';
            closeModal('deleteModal');

            if (isBatch) {
                const items = Array.from(selectedItems).map(id => {
                    const item = data.find(d => d.id === id);
                    return { id: item.id, path: item.image_path };
                });

                fetch('/api/delete-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(items)
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        for (const id of selectedItems) {
                            const idx = data.findIndex(d => d.id === id);
                            if (idx > -1) data.splice(idx, 1);
                        }
                        selectedItems.clear();
                        updateSelectionUI();
                        applyFilters();
                    }
                });
            } else {
                const item = filteredData[currentIndex];
                fetch(`/api/delete-image?path=${encodeURIComponent(item.image_path)}&id=${encodeURIComponent(item.id)}`, {
                    method: 'DELETE'
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        const idx = data.findIndex(d => d.id === item.id);
                        if (idx > -1) data.splice(idx, 1);
                        applyFilters();
                    }
                });
            }
        }

        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            if (e.key === 'ArrowLeft') navigate(-1);
            if (e.key === 'ArrowRight') navigate(1);
            if (e.key === 'p' || e.key === 'P') openPdfAtPage();
            if (e.key === 'e' || e.key === 'E') openEditModal();
            if (e.key === 'r' || e.key === 'R') rotateImage(90);
            if (e.key === 'Escape') {
                closeModal('deleteModal');
                closeModal('editModal');
                closeModal('batchEditModal');
            }
        });
    </script>
</body>
</html>
